apiVersion: v1
kind: ConfigMap
metadata:
  name: {{ include "typesense.fullname" . }}-scraper-config
  labels:
  {{- include "typesense.labels" . | nindent 4 }}
data:
  config.json: "{\"index_name\":\"docs-next\",\"start_urls\":[\"http://{{ .Values.docusaurus.host }}/\"],\"sitemap_urls\":[\"http://{{ .Values.docusaurus.host }}/sitemap.xml\"],\"sitemap_alternate_links\":true,\"stop_urls\":[\"/tests\"],\"selectors\":{\"lvl0\":{\"selector\":\"(//ul[contains(@class,'menu__list')]//a[contains(@class, 'menu__link menu__link--sublist menu__link--active')]/text() | //nav[contains(@class, 'navbar')]//a[contains(@class, 'navbar__link--active')]/text())[last()]\",\"type\":\"xpath\",\"global\":true,\"default_value\":\"Documentation\"},\"lvl1\":\"header h1\",\"lvl2\":\"article h2\",\"lvl3\":\"article h3\",\"lvl4\":\"article h4\",\"lvl5\":\"article h5, article td:first-child\",\"lvl6\":\"article h6\",\"text\":\"article p, article li, article td:last-child\"},\"strip_chars\":\" .,;:#\",\"custom_settings\":{\"separatorsToIndex\":\"_\",\"attributesForFaceting\":[\"language\",\"version\",\"type\",\"docusaurus_tag\"],\"attributesToRetrieve\":[\"hierarchy\",\"content\",\"anchor\",\"url\",\"url_without_anchor\",\"type\"]},\"conversation_id\":[\"833762294\"],\"nb_hits\":46250}"
---
apiVersion: batch/v1
kind: CronJob
metadata:
  name: {{ include "typesense.fullname" . }}-scraper
  labels:
  {{- include "typesense.labels" . | nindent 4 }}
spec:
  concurrencyPolicy: Forbid
  jobTemplate:
    spec:
      backoffLimit: 0
      template:
        spec:
          containers:
          - env:
            - name: CONFIG
              valueFrom:
                configMapKeyRef:
                  key: config.json
                  name: {{ include "typesense.fullname" . }}-scraper-config
            - name: TYPESENSE_API_KEY
              valueFrom:
                secretKeyRef:
                  key: typesense-api-key
                  name: {{ include "typesense.fullname" . }}-api-keys
            - name: TYPESENSE_HOST
              value: {{ quote .Values.typesenseScraper.typesenseScraper.env.typesenseHost
                }}
            - name: TYPESENSE_PORT
              value: {{ quote .Values.typesenseScraper.typesenseScraper.env.typesensePort
                }}
            - name: TYPESENSE_PROTOCOL
              value: {{ quote .Values.typesenseScraper.typesenseScraper.env.typesenseProtocol
                }}
            - name: KUBERNETES_CLUSTER_DOMAIN
              value: {{ quote .Values.kubernetesClusterDomain }}
            image: {{ .Values.typesenseScraper.typesenseScraper.image.repository
              }}:{{ .Values.typesenseScraper.typesenseScraper.image.tag | default
              .Chart.AppVersion }}
            name: typesense-scraper
            resources: {{- toYaml .Values.typesenseScraper.typesenseScraper.resources
              | nindent 10 }}
          restartPolicy: Never
  schedule: {{ .Values.typesenseScraper.schedule | quote }}